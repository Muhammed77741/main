# Исправление Расчёта Прибыли - Диалог Статистики

## Сообщённая Проблема
@orkenpunkitbay01-spec сообщил: "gui в statistics неправильно показывает profit usd profit %"

## Найденные Причины

### 1. Расчёт Процента Прибыли (НЕПРАВИЛЬНО)

**Местоположение:** `trading_bots/xauusd_bot/live_bot_mt5_fullauto.py`, строка 456

**Старый Код (Неправильный):**
```python
# Расчёт пипсов
if pos['type'] == 'BUY':
    pips = (close_price - pos['entry_price']) * 10  # Для XAUUSD
else:
    pips = (pos['entry_price'] - close_price) * 10
pos['pips'] = round(pips, 1)

# Расчёт процента прибыли - НЕПРАВИЛЬНО!
profit_pct = (pips / pos['entry_price']) * 100 if pos['entry_price'] > 0 else 0
```

**Проблема:** Формула `(pips / entry_price) * 100` математически неверна:
- `pips` = разница_цен * 10
- Деление `pips` на `entry_price` (например, 100 / 2000) даёт бессмысленное соотношение
- Результат: profit % **в 10 раз больше** реального

**Пример:**
- Вход: $2000, Закрытие: $2010 (BUY)
- pips = 100
- Старая формула: `(100 / 2000) * 100 = 5.00%` ❌ НЕПРАВИЛЬНО
- Реальная прибыль: 0.5% (10/2000 = 0.005 = 0.5%)

**Новый Код (Правильный):**
```python
# Расчёт процента прибыли - исправленная формула
if pos['entry_price'] > 0:
    if pos['type'] == 'BUY':
        profit_pct = ((close_price - pos['entry_price']) / pos['entry_price']) * 100
    else:
        profit_pct = ((pos['entry_price'] - close_price) / pos['entry_price']) * 100
else:
    profit_pct = 0.0
```

**Формула:** `(изменение_цены / цена_входа) * 100`
- Это стандартная формула процентного изменения
- Совпадает с правильным расчётом в других частях кода (строки 3236-3238)
- Совпадает с реализацией в крипто-боте

---

### 2. Расчёт Прибыли в USD (НЕПРАВИЛЬНО)

**Местоположение:** `trading_bots/xauusd_bot/live_bot_mt5_fullauto.py`, строки 676-678

**Старый Код (Неправильный):**
```python
# Расчёт прибыли
if trade.trade_type == 'BUY':
    profit = (close_price - trade.entry_price) * trade.amount
else:
    profit = (trade.entry_price - close_price) * trade.amount
```

**Проблема:** Отсутствует множитель размера контракта XAUUSD
- Для XAUUSD: 1 лот = 100 тройских унций
- Стоимость пункта = $100 за лот при движении на 1 пункт ($1)
- В формуле отсутствовал множитель `* 100`
- Результат: profit USD **в 100 раз меньше** реального

**Пример:**
- Вход: $2000, Закрытие: $2010 (BUY)
- Размер лота: 0.1
- Старая формула: `10 * 0.1 = $1.00` ❌ НЕПРАВИЛЬНО
- Правильно: `10 * 0.1 * 100 = $100.00` ✅

**Новый Код (Правильный):**
```python
# Расчёт прибыли для XAUUSD (1 лот = 100 унций, стоимость пункта = $100)
if trade.trade_type == 'BUY':
    profit = (close_price - trade.entry_price) * trade.amount * 100
else:
    profit = (trade.entry_price - close_price) * trade.amount * 100
```

**Формула:** `изменение_цены * размер_лота * 100`
- Учитывает размер контракта XAUUSD (100 унций на лот)
- Совпадает с расчётами в других местах кода (например, строка с `point_value = 100.0`)

---

## Влияние Ошибок

### До Исправления (Примеры):

| Сценарий | Вход | Закрытие | Лот | Старый Profit % | Старый Profit USD | Правильный Profit % | Правильный Profit USD |
|----------|------|----------|-----|-----------------|-------------------|---------------------|------------------------|
| BUY +$10 | $2000 | $2010 | 0.1 | **5.00%** ❌ | **$1.00** ❌ | 0.50% ✅ | $100.00 ✅ |
| BUY +$5  | $2000 | $2005 | 0.5 | **2.50%** ❌ | **$2.50** ❌ | 0.25% ✅ | $250.00 ✅ |
| SELL +$20| $2000 | $1980 | 1.0 | **10.00%** ❌| **$20.00** ❌| 1.00% ✅ | $2000.00 ✅|

**Ошибки:**
- Profit % был **в 10 раз больше** реального
- Profit USD был **в 100 раз меньше** реального

---

## Когда Возникает Эта Ошибка?

**Затронуто:** Только позиции, закрытые вручную в MT5 (во время синхронизации базы данных)

**Не затронуто:** Позиции, закрытые ботом через TP/SL (используется `deal.profit` из MT5, который правильный)

**Путь кода:**
1. Пользователь вручную закрывает позицию в MT5
2. Бот синхронизирует базу данных (строка 666: "Position manually closed on MT5 - syncing database")
3. Бот рассчитывает прибыль по неправильным формулам (строки 676-678)
4. Бот логирует закрытую позицию с неправильными значениями прибыли (строка 684)
5. Неправильные значения сохраняются в базу данных и отображаются в статистике

---

## Проверка Исправления

### Результаты Тестов:
```
Testing profit percentage calculation...
✅ BUY position profit %: 0.50% (правильно)
✅ BUY position loss %: -0.50% (правильно)
✅ SELL position profit %: 0.50% (правильно)
✅ SELL position loss %: -0.50% (правильно)

Testing profit USD calculation for XAUUSD...
✅ BUY position (0.1 lot, $10 gain): $100.00 profit (правильно)
✅ BUY position (1 lot, $1 gain): $100.00 profit (правильно)
✅ SELL position (0.1 lot, $10 gain): $100.00 profit (правильно)
✅ BUY position (0.5 lot, $5 loss): $-250.00 profit (правильно)

Comparing OLD (wrong) vs NEW (correct) formulas...
Profit Percentage:
  Entry: $2000.00, Close: $2010.00
  СТАРАЯ (неправильно): 5.00%
  НОВАЯ (правильно): 0.50%
  Разница: 4.50%

Profit USD:
  Lot size: 0.1
  Price change: $10.00
  СТАРАЯ (неправильно): $1.00
  НОВАЯ (правильно): $100.00
  Разница: $99.00
```

---

## Изменённые Файлы

1. **trading_bots/xauusd_bot/live_bot_mt5_fullauto.py**
   - Строка 456: Исправлен расчёт profit_percent
   - Строка 676: Исправлен расчёт profit USD (добавлен * 100)

2. **test_profit_calculation_fix.py** (НОВЫЙ)
   - Комплексные тесты для обоих расчётов
   - Демонстрация старой и новой формул

---

## Рекомендация

**Существующие Записи в Базе Данных:** 
- Сделки, закрытые до этого исправления, всё ещё имеют неправильные значения прибыли в базе
- Их можно определить по большим расхождениям (profit % в 10 раз больше, profit USD в 100 раз меньше)
- Рассмотрите возможность запуска скрипта миграции для пересчёта затронутых сделок, если историческая точность важна

**Новые Сделки:**
- Все новые вручную закрытые позиции теперь будут иметь правильные расчёты прибыли
- Статистика будет отображать точные значения

---

## Резюме

✅ Исправлен расчёт процента прибыли (был в 10 раз больше)
✅ Исправлен расчёт прибыли в USD (был в 100 раз меньше)
✅ Добавлены комплексные тесты
✅ Формулы теперь совпадают с расчётами MT5 и логикой крипто-бота
✅ Диалог статистики теперь будет показывать правильные значения прибыли
