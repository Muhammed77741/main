"""
ТЕСТ: Проверка динамического фильтра на разных таймфреймах

Проверяет, что фильтр правильно работает на H1, M30, M15, M5
"""

print("="*80)
print("ТЕСТ: Динамический фильтр по времени сигнала")
print("="*80)

# Симулируем новую логику
SIGNAL_MIN_AGE_MULTIPLIER = 0.5
SIGNAL_MAX_AGE_MULTIPLIER = 1.5

# Таймфреймы для тестирования
timeframes = [
    ("H1", 1.0, "1 час"),
    ("M30", 0.5, "30 минут"),
    ("M15", 0.25, "15 минут"),
    ("M5", 5/60, "5 минут"),
]

print("\n📊 ТЕСТИРОВАНИЕ ДИНАМИЧЕСКОГО ФИЛЬТРА:")
print("="*80)

all_passed = True

for tf_name, tf_hours, tf_desc in timeframes:
    print(f"\n{tf_name} ({tf_desc}) - Таймфрейм = {tf_hours:.4f} часов")
    print("-" * 60)
    
    # Вычисляем динамические пороги
    signal_min_age = SIGNAL_MIN_AGE_MULTIPLIER * tf_hours
    signal_max_age = SIGNAL_MAX_AGE_MULTIPLIER * tf_hours
    
    print(f"Динамические пороги:")
    print(f"  MIN = {SIGNAL_MIN_AGE_MULTIPLIER} × {tf_hours:.4f} = {signal_min_age:.4f}ч ({signal_min_age*60:.1f} мин)")
    print(f"  MAX = {SIGNAL_MAX_AGE_MULTIPLIER} × {tf_hours:.4f} = {signal_max_age:.4f}ч ({signal_max_age*60:.1f} мин)")
    print()
    
    # Тест 1: Сигнал на последнем закрытом баре (возраст = 1 бар)
    signal_age = tf_hours
    print(f"Тест 1: Сигнал на последнем закрытом баре")
    print(f"  Возраст сигнала: {signal_age:.4f}ч ({signal_age*60:.1f} мин)")
    print(f"  Фильтр: {signal_min_age:.4f} <= {signal_age:.4f} <= {signal_max_age:.4f}?")
    
    if signal_min_age <= signal_age <= signal_max_age:
        print(f"  ✅ ПРОХОДИТ - сигнал принимается")
    else:
        print(f"  ❌ НЕ ПРОХОДИТ - сигнал отклоняется")
        all_passed = False
    
    # Тест 2: Сигнал на текущей незакрытой свече (возраст = 0)
    signal_age = 0.0
    print(f"\nТест 2: Сигнал на текущей незакрытой свече")
    print(f"  Возраст сигнала: {signal_age:.4f}ч")
    print(f"  Фильтр: {signal_min_age:.4f} <= {signal_age:.4f} <= {signal_max_age:.4f}?")
    
    if signal_age < signal_min_age:
        print(f"  ✅ ПРАВИЛЬНО ОТКЛОНЕН - текущая свеча")
    else:
        print(f"  ❌ ОШИБКА - должен отклонять текущую свечу")
        all_passed = False
    
    # Тест 3: Старый сигнал (возраст = 2 бара)
    signal_age = 2 * tf_hours
    print(f"\nТест 3: Старый сигнал (2 бара назад)")
    print(f"  Возраст сигнала: {signal_age:.4f}ч ({signal_age*60:.1f} мин)")
    print(f"  Фильтр: {signal_min_age:.4f} <= {signal_age:.4f} <= {signal_max_age:.4f}?")
    
    if signal_age > signal_max_age:
        print(f"  ✅ ПРАВИЛЬНО ОТКЛОНЕН - слишком старый")
    else:
        print(f"  ❌ ОШИБКА - должен отклонять старые сигналы")
        all_passed = False

print("\n\n" + "="*80)
print("СРАВНЕНИЕ: СТАРЫЙ vs НОВЫЙ ФИЛЬТР")
print("="*80)

print("""
┌──────────┬────────────────────────────┬────────────────────────────┐
│ Таймфрейм│ Старый фильтр (0.5-1.5ч)  │ Новый динамический фильтр  │
├──────────┼────────────────────────────┼────────────────────────────┤
│ H1 (1ч)  │ ✅ Работает (1.0ч ок)      │ ✅ Работает (0.5-1.5ч)     │
│ M30(30м) │ ✅ Работает (0.5ч ок)      │ ✅ Работает (0.25-0.75ч)   │
│ M15(15м) │ ❌ НЕ работает (0.25ч<0.5) │ ✅ Работает (0.125-0.375ч) │
│ M5 (5м)  │ ❌ НЕ работает (0.08ч<0.5) │ ✅ Работает (0.04-0.12ч)   │
└──────────┴────────────────────────────┴────────────────────────────┘
""")

print("\n" + "="*80)
if all_passed:
    print("✅ ВСЕ ТЕСТЫ ПРОЙДЕНЫ!")
    print("="*80)
    print("""
Динамический фильтр работает на ВСЕХ таймфреймах!

Теперь бот защищен фильтром на:
• H1 (1 час)
• M30 (30 минут)
• M15 (15 минут) ← ИСПРАВЛЕНО!
• M5 (5 минут) ← ИСПРАВЛЕНО!

Фильтр автоматически подстраивается под таймфрейм и:
✅ Принимает сигналы с последнего закрытого бара
✅ Отклоняет сигналы с текущего незакрытого бара
✅ Отклоняет старые сигналы (>1.5 бара)
""")
else:
    print("❌ НЕКОТОРЫЕ ТЕСТЫ НЕ ПРОШЛИ!")
    print("="*80)

print("="*80)
