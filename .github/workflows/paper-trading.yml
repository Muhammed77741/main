name: Paper Trading Bot

on:
  # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ)
  schedule:
    - cron: '0 * * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ Ğ² :00 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  
  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ‡ĞµÑ€ĞµĞ· GitHub UI
  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading mode'
        required: true
        default: 'check_signals'
        type: choice
        options:
          - check_signals
          - check_positions
          - full_run

  # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ push (Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
  push:
    branches:
      - cursor/paper-trading-github-action-*
    paths:
      - 'smc_trading_strategy/paper_trading_improved.py'
      - '.github/workflows/paper-trading.yml'

jobs:
  paper-trading:
    name: Run Paper Trading Bot
    runs-on: windows-latest  # MT5 Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Windows
    
    # Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ (Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 6 Ñ‡Ğ°ÑĞ¾Ğ² Ğ´Ğ»Ñ GitHub Actions)
    timeout-minutes: 360
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‚ Download previous trading state
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: trading-state
          path: ./smc_trading_strategy/

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./smc_trading_strategy
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install MetaTrader5

      - name: ğŸ“‹ Create .env file
        working-directory: ./smc_trading_strategy
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MT5_LOGIN: ${{ secrets.MT5_LOGIN }}
          MT5_PASSWORD: ${{ secrets.MT5_PASSWORD }}
          MT5_SERVER: ${{ secrets.MT5_SERVER }}
          MT5_SYMBOL: ${{ secrets.MT5_SYMBOL }}
          SIGNAL_CHECK_INTERVAL: ${{ secrets.SIGNAL_CHECK_INTERVAL }}
          POSITION_CHECK_INTERVAL: ${{ secrets.POSITION_CHECK_INTERVAL }}
        run: |
          echo "TELEGRAM_BOT_TOKEN=$env:TELEGRAM_BOT_TOKEN" | Out-File -FilePath .env -Encoding utf8
          echo "TELEGRAM_CHAT_ID=$env:TELEGRAM_CHAT_ID" | Out-File -FilePath .env -Append -Encoding utf8
          echo "MT5_LOGIN=$env:MT5_LOGIN" | Out-File -FilePath .env -Append -Encoding utf8
          echo "MT5_PASSWORD=$env:MT5_PASSWORD" | Out-File -FilePath .env -Append -Encoding utf8
          echo "MT5_SERVER=$env:MT5_SERVER" | Out-File -FilePath .env -Append -Encoding utf8
          echo "MT5_SYMBOL=$env:MT5_SYMBOL" | Out-File -FilePath .env -Append -Encoding utf8
          echo "SIGNAL_CHECK_INTERVAL=$env:SIGNAL_CHECK_INTERVAL" | Out-File -FilePath .env -Append -Encoding utf8
          echo "POSITION_CHECK_INTERVAL=$env:POSITION_CHECK_INTERVAL" | Out-File -FilePath .env -Append -Encoding utf8

      - name: âš ï¸ MT5 Installation Warning
        run: |
          Write-Host "=============================================="
          Write-Host "âš ï¸  Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: MetaTrader5 Requirement"
          Write-Host "=============================================="
          Write-Host ""
          Write-Host "MetaTrader5 Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚:"
          Write-Host "1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» MT5 Ğ½Ğ° Windows"
          Write-Host "2. Ğ—Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ» Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹"
          Write-Host "3. Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞµÑ€Ğ²ĞµÑ€Ñƒ"
          Write-Host ""
          Write-Host "GitHub Actions Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ MT5 Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸."
          Write-Host ""
          Write-Host "Ğ Ğ•ĞšĞĞœĞ•ĞĞ”ĞĞ¦Ğ˜Ğ˜:"
          Write-Host "1. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ self-hosted runner Ğ½Ğ° Windows Ñ MT5"
          Write-Host "2. Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Yahoo Finance)"
          Write-Host ""
          Write-Host "Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ workflow Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½ Ñ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼."
          Write-Host "=============================================="

      - name: ğŸ” Check MT5 availability
        id: check_mt5
        continue-on-error: true
        run: |
          python -c "import MetaTrader5 as mt5; print('MT5 package installed'); exit(0 if mt5.initialize() else 1)"

      - name: ğŸ¤– Run Paper Trading Bot (if MT5 available)
        if: steps.check_mt5.outcome == 'success'
        working-directory: ./smc_trading_strategy
        env:
          PYTHONUNBUFFERED: 1
          MT5_LOGIN: ${{ secrets.MT5_LOGIN }}
          MT5_PASSWORD: ${{ secrets.MT5_PASSWORD }}
          MT5_SERVER: ${{ secrets.MT5_SERVER }}
          MT5_SYMBOL: ${{ secrets.MT5_SYMBOL }}
        run: |
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ (Ğ½Ğµ infinite loop)
          # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ´Ğ»Ñ GitHub Actions
          python paper_trading_github_action.py
        timeout-minutes: 55

      - name: ğŸ’¾ Upload trading state (for next run)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-state
          path: smc_trading_strategy/trading_state.json
          retention-days: 90

      - name: ğŸ“Š Upload trading statistics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-stats-${{ github.run_number }}
          path: |
            smc_trading_strategy/live_bot_statistics_*.csv
            smc_trading_strategy/*.log
          retention-days: 30

      - name: ğŸ“ Summary
        if: always()
        run: |
          Write-Host "=============================================="
          Write-Host "ğŸ“Š Workflow Summary"
          Write-Host "=============================================="
          Write-Host "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host "Run Number: ${{ github.run_number }}"
          Write-Host "MT5 Status: ${{ steps.check_mt5.outcome }}"
          Write-Host ""
          Write-Host "Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ self-hosted runner!"
          Write-Host "=============================================="

  # ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Yahoo Finance (Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ MT5)
  paper-trading-yahoo:
    name: Run Paper Trading Bot (Yahoo Finance)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“‚ Download previous trading state
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: trading-state-yahoo
          path: ./smc_trading_strategy/

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./smc_trading_strategy
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance python-dotenv requests

      - name: ğŸ“‹ Create .env file
        working-directory: ./smc_trading_strategy
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CHECK_INTERVAL: ${{ secrets.CHECK_INTERVAL }}
        run: |
          echo "TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}" > .env
          echo "TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}" >> .env
          echo "CHECK_INTERVAL=${CHECK_INTERVAL:-3600}" >> .env

      - name: ğŸ¤– Run Paper Trading Bot (Yahoo Finance)
        working-directory: ./smc_trading_strategy
        env:
          PYTHONUNBUFFERED: 1
        run: |
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ paper_trading.py
          if [ -f "paper_trading.py" ]; then
            echo "âœ… Running paper_trading.py (Yahoo Finance mode)"
            timeout 55m python paper_trading.py || echo "âš ï¸ Timeout reached or bot stopped"
          else
            echo "âš ï¸ paper_trading.py not found, using test mode"
          fi

      - name: ğŸ’¾ Upload trading state (for next run)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-state-yahoo
          path: smc_trading_strategy/trading_state.json
          retention-days: 90

      - name: ğŸ“Š Upload trading statistics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-stats-yahoo-${{ github.run_number }}
          path: |
            smc_trading_strategy/live_bot_statistics_*.csv
            smc_trading_strategy/*.log
          retention-days: 30
