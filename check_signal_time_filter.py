"""
ОТВЕТ: Есть ли у меня фильтр по времени сигнала?

Показывает существующую фильтрацию сигналов по времени в Live Bot
"""

print("="*80)
print("ВОПРОС: А у меня есть фильтр по времени сигнала?")
print("="*80)

print("""
✅ ДА! У вас УЖЕ ЕСТЬ фильтр по времени сигнала!
================================================

Фильтр реализован в Live Bot и работает следующим образом:


1. КОНСТАНТЫ ФИЛЬТРАЦИИ (строки 74-75):
========================================

SIGNAL_MIN_AGE_HOURS = 0.5   # Минимальный возраст сигнала
SIGNAL_MAX_AGE_HOURS = 1.5   # Максимальный возраст сигнала


2. КАК ЭТО РАБОТАЕТ (для H1 таймфрейма):
=========================================

Когда бот проверяет сигнал, он вычисляет его "возраст":
- Возраст = текущее время - время сигнала

Затем применяет фильтр:
┌─────────────────────────────────────────────────────────────┐
│ Возраст сигнала │ Действие                                  │
├─────────────────┼───────────────────────────────────────────┤
│ < 0.5 часов     │ ❌ ОТКЛОНИТЬ (текущая незакрытая свеча)   │
│ 0.5 - 1.5 часов │ ✅ ПРИНЯТЬ (закрытая свеча)               │
│ > 1.5 часов     │ ❌ ОТКЛОНИТЬ (слишком старый)             │
└─────────────────┴───────────────────────────────────────────┘


3. ЛОГИКА ФИЛЬТРАЦИИ (строки 2450-2482):
=========================================

Приоритет 1: Проверка последнего закрытого бара
------------------------------------------------
last_closed_bar_time = df.index[-2]  # Последняя закрытая свеча
signals_from_last_closed = signals[signals.index == last_closed_bar_time]

if len(signals_from_last_closed) > 0:
    # Найден сигнал на последней закрытой свече
    ✅ ИСПОЛЬЗУЕМ ЕГО!
    
else:
    # Нет сигнала на последней закрытой свече
    # Проверяем ЗАПАСНОЙ ВАРИАНТ с временным фильтром:
    
    time_diff_hours = (current_bar_time - last_signal_time).total_seconds() / 3600
    
    if SIGNAL_MIN_AGE_HOURS <= time_diff_hours <= SIGNAL_MAX_AGE_HOURS:
        ✅ ПРИНИМАЕМ (сигнал в допустимом временном диапазоне)
    else:
        ❌ ОТКЛОНЯЕМ (сигнал слишком свежий или слишком старый)


4. ПРИМЕРЫ РАБОТЫ ФИЛЬТРА:
===========================

Сценарий А: Бот запускается в 14:00
------------------------------------
Сигнал на 13:00 (закрылся в 14:00):
  - Возраст = 1.0 час
  - Фильтр: 0.5 <= 1.0 <= 1.5 ✅
  - Результат: ПРИНИМАЕТСЯ

Сигнал на 14:00 (текущая свеча):
  - Возраст = 0.0 часов
  - Фильтр: 0.0 < 0.5 ❌
  - Результат: ОТКЛОНЯЕТСЯ


Сценарий Б: Бот запускается в 14:30 (середина часа)
-----------------------------------------------------
Сигнал на 13:00:
  - Возраст = 1.5 часа
  - Фильтр: 0.5 <= 1.5 <= 1.5 ✅
  - Результат: ПРИНИМАЕТСЯ

Сигнал на 14:00 (текущая свеча):
  - Возраст = 0.5 часа
  - Фильтр: 0.5 <= 0.5 <= 1.5 ✅
  - Результат: ПРИНИМАЕТСЯ (граничный случай)


Сценарий В: Старый сигнал
--------------------------
Сигнал на 12:00 (2 часа назад):
  - Возраст = 2.0 часа
  - Фильтр: 2.0 > 1.5 ❌
  - Результат: ОТКЛОНЯЕТСЯ (слишком старый)


5. ГДЕ НАХОДИТСЯ КОД:
======================

Файл: trading_bots/xauusd_bot/live_bot_mt5_fullauto.py

Константы (строки 74-75):
-------------------------
SIGNAL_MIN_AGE_HOURS = 0.5
SIGNAL_MAX_AGE_HOURS = 1.5

Логика фильтрации (строки 2450-2482):
-------------------------------------
В методе analyze_market()


6. ТАКЖЕ ЕСТЬ В CRYPTO BOT:
============================

Файл: trading_bots/crypto_bot/live_bot_binance_fullauto.py
Строки: 27-28 (константы), 1718-1768 (логика)


7. ИТОГИ:
=========

✅ У вас ЕСТЬ фильтр по времени сигнала!
✅ Он работает на ОБОИХ ботах (MT5 и Crypto)
✅ Фильтр защищает от:
   - Торговли на незакрытых свечах (< 0.5ч)
   - Торговли на слишком старых сигналах (> 1.5ч)
✅ Фильтр обеспечивает торговлю только на закрытых свечах


НАСТРОЙКА:
==========

Если хотите изменить временные пороги:

1. Откройте файл live_bot_mt5_fullauto.py
2. Найдите строки 74-75
3. Измените значения:
   SIGNAL_MIN_AGE_HOURS = 0.5  # ваше значение
   SIGNAL_MAX_AGE_HOURS = 1.5  # ваше значение

ВАЖНО: Значения должны соответствовать вашему таймфрейму!
- Для H1 (часовой): 0.5 - 1.5 часов (текущие)
- Для H4 (4 часа): возможно 2.0 - 6.0 часов
- Для M15 (15 минут): возможно 0.25 - 0.75 часов
""")

print("\n" + "="*80)
print("ВЫВОД:")
print("="*80)
print("""
✅ ДА, у вас есть фильтр по времени сигнала!

Он автоматически:
• Отклоняет незакрытые свечи (< 0.5ч)
• Принимает закрытые свечи (0.5-1.5ч)
• Отклоняет старые сигналы (> 1.5ч)

Фильтр работает и защищает ваш бот! 🎯
""")
print("="*80)
